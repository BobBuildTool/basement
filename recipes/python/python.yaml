inherit: [autotools, make, patch]

metaEnvironment:
    PKG_VERSION: "2.7.15"

privateEnvironment:
    APPLY_LIBTOOL_PATCH: "no"

checkoutSCM:
    scm: url
    url: https://www.python.org/ftp/python/${PKG_VERSION}/Python-${PKG_VERSION}.tar.xz
    digestSHA1: "f99348a095ec4a6411c84c0d15343d11920c9724"
    stripComponents: 1

checkoutDeterministic: True
checkoutScript: |
    patchApplySeries $<<python/*>>

buildScript: |
    mkdir -p src
    rsync -aH --delete $1/ src/

    # The make file will compile all python standard library files during
    # installation. This is done with a PYTHONPATH pointing to the installation
    # directory. Unfortunately this means that extension modules are also
    # loaded from there which require libpython2.7.so.1.0...
    export LD_LIBRARY_PATH="$BOB_CWD/install/usr/lib"

multiPackage:
    "":
        depends:
           - libs::expat-dev
           - libs::gdbm-dev
           - libs::libffi-dev
           - libs::ncurses-dev
           - libs::openssl-dev
           - libs::zlib-dev

           - use: []
             depends:
              - libs::expat-tgt
              - libs::gdbm-tgt
              - libs::libffi-tgt
              - libs::ncurses-tgt
              - libs::openssl-tgt
              - libs::zlib-tgt

           - name: python::python-host-static
             use: [tools]

        buildTools: [python]
        buildScript: |
            export ac_cv_file__dev_ptmx=yes
            export ac_cv_file__dev_ptc=no

            autotoolsBuild $PWD/src \
                --with-threads \
                --enable-ipv6 \
                --enable-unicode=ucs4 \
                --with-dbmliborder=gdbm:ndbm \
                --without-ensurepip

        packageScript: |
            autotoolsPackageTgt

        provideDeps: [ "*-tgt" ]

    host-static:
        buildTools: [host-toolchain]
        buildScript: |
            unset AUTOCONF_BUILD
            unset AUTOCONF_HOST
            autotoolsBuild $PWD/src \
                --libdir=/usr/lib \
                --without-cxx-main \
                --disable-sqlite3 \
                --disable-tk \
                --with-expat=system \
                --disable-curses \
                --disable-codecs-cjk \
                --disable-nis \
                --enable-unicodedata \
                --disable-dbm \
                --disable-gdbm \
                --disable-bsddb \
                --disable-test-modules \
                --disable-bz2 \
                --disable-ssl \
                --disable-ossaudiodev \
                --disable-pyo-build
        packageScript: |
            autotoolsPackageTgt

        provideTools:
            python: usr/bin
