metaEnvironment:
    PKG_VERSION: "0.59.4"

checkoutSCM:
    scm: url
    url: ${GITHUB_MIRROR}/mesonbuild/meson/archive/${PKG_VERSION}.tar.gz
    digestSHA256: 032276804563e78b037f55148e26bf890ed0101a8c9ea740a7c6682b33ef076a
    extract: false

# TODO: fingerprint Python version? The result will have .pyc files that depend
# on the python version. OTOH python is smart enough to ignore them if they
# don't match and compile the .py files on the fly. It will just be a bit
# slower in this case.

buildVars: [PKG_VERSION]
buildScript: |
    mkdir -p build install
    pushd build
    tar -xf "$1/${PKG_VERSION}.tar.gz" --strip-components=1
    python3 setup.py install \
        --root "$PWD/../install" \
        --prefix /usr \
        --install-lib /usr/lib/python3
    popd

    # Make the executable relocatable
    pushd install
    sed -i -e '2i import os\
    import sys\
    sys.path.insert(0, os.path.join(os.path.dirname(__file__), "..", "lib", "python3"))' \
        usr/bin/meson
    popd

packageScript: |
    rsync -a "$1/install/" .
provideTools:
    meson: usr/bin
