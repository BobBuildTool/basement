inherit: [autotools, patch]

environment:
    BINUTILS_VERSION: "2.29.1"

checkoutSCM:
    scm: url
    url: ${GNU_MIRROR}/binutils/binutils-${BINUTILS_VERSION}.tar.xz
    digestSHA1: "172244a349d07ec205c39c0321cbc354c125e78e"

checkoutVars: [BINUTILS_VERSION]
checkoutDeterministic: True
checkoutScript: |
    cd binutils-${BINUTILS_VERSION}
    patchApplySeries \
        $<<binutils/129_multiarch_libpath.patch>> \
        $<<binutils/aarch64-libpath.diff>>

# Some parts are compiled for the host during compilation. Hence we need the
# host toolchain too.
buildTools: [host-toolchain]

buildVars: [AUTOCONF_HOST, AUTOCONF_TARGET, BINUTILS_PREFIX, MULTIARCH_HOST,
            MULTIARCH_TARGET]
buildScript: |
    # handle multiarch the debian way... (taken from binutils rules)
    MULTIARCH_TARGET="${MULTIARCH_TARGET:-${MULTIARCH_HOST}}"
    export DEB_TARGET_MULTIARCH="$MULTIARCH_TARGET"
    case "$DEB_TARGET_MULTIARCH" in
        aarch64-linux-gnu)
            export DEB_TARGET_MULTIARCH32=aarch64_ilp32-linux-gnu
            ;;
        i386-linux-gnu)
            export DEB_TARGET_MULTIARCH64=x86_64-linux-gnu
            export DEB_TARGET_MULTIARCHX32=x86_64-linux-gnux32
            ;;
        x86_64-linux-gnu)
            export DEB_TARGET_MULTIARCH32=i386-linux-gnu
            export DEB_TARGET_MULTIARCHX32=x86_64-linux-gnux32
            ;;
        x86_64-linux-gnux32)
            export DEB_TARGET_MULTIARCH32=i386-linux-gnu
            export DEB_TARGET_MULTIARCH64=x86_64-linux-gnu
            ;;
    esac

    export ac_cv_prog_MAKEINFO=missing
    autotoolsBuild $1/binutils-${BINUTILS_VERSION} \
        ${BINUTILS_PREFIX:+--prefix=${BINUTILS_PREFIX}} \
        --with-sysroot=${BINUTILS_PREFIX:-/usr}/sysroots/$MULTIARCH_TARGET \
        --enable-deterministic-archives \
        --disable-nls \
        --disable-werror \
        --enable-plugins \
        --enable-lto

packageScript: |
    autotoolsPackageTgt

    # make sure that prefixed versions are available on native build
    if [[ $AUTOCONF_HOST = ${AUTOCONF_TARGET:-$AUTOCONF_HOST} ]] ; then
        pushd ./${BINUTILS_PREFIX:-/usr}/bin
        for i in *; do
            ln -s "$i" "${AUTOCONF_HOST}-$i"
        done
        popd
    fi

provideTools:
    binutils: usr/bin

