inherit: [autotools, patch]

metaEnvironment:
    PKG_VERSION: "2.45.1"
    PKG_LICENSE: "FSFAP AND GFDL-1.3 AND GPL-2.0-or-later AND LGPL-2.0-or-later"

checkoutSCM:
    scm: url
    url: ${GNU_MIRROR}/binutils/binutils-${PKG_VERSION}.tar.xz
    digestSHA1: "db1bb5b24bab487664380f4cbb498c8b2595e5a8"
    stripComponents: 1

checkoutDeterministic: True
checkoutScript: |
    patchApplySeries $<@binutils/*.patch@>

# Some parts are compiled for the host during compilation. Hence we need the
# host toolchain too.
buildTools: [host-toolchain, bison]
buildToolsWeak: [m4]
multiPackage:
    "":
        Config:
            BINUTILS_ZSTD:
                type: bool
                help: "Enable zstd compression support for debug sections"
                default: False
            BINUTILS_COMPRESS_DEBUG:
                type: bool
                help: "Compress debug sections by default in linker"
                default: False

        depends:
            - if: $BINUTILS_ZSTD
              depends:
                  - libs::zstd-dev
                  - name: libs::zstd-tgt
                    use: []

        buildVars: [AUTOCONF_HOST, AUTOCONF_TARGET, BINUTILS_PREFIX,
                    BINUTILS_ZSTD, BINUTILS_COMPRESS_DEBUG]
        buildScript: |
            export MAKEINFO=true
            autotoolsBuild -o MAKEINFO=true -O MAKEINFO=true $1 \
                ${BINUTILS_PREFIX:+--prefix=${BINUTILS_PREFIX}} \
                --with-sysroot=${BINUTILS_PREFIX:-/usr}/sysroots/${AUTOCONF_TARGET:-${AUTOCONF_HOST:-$AUTOCONF_BUILD}} \
                --enable-deterministic-archives \
                --enable-default-hash-style=gnu \
                --disable-nls \
                --disable-werror \
                --enable-plugins \
                --enable-lto \
                --enable-compressed-debug-sections=$([[ $BINUTILS_COMPRESS_DEBUG == 1 ]] && echo ld || echo none) \
                --enable-default-compressed-debug-sections-algorithm=$(\
                    [[ $BINUTILS_ZSTD == 1 ]] && echo zstd || echo zlib)

        multiPackage:
            dev:
                packageScript: |
                    autotoolsPackageDev
                provideDeps: [ "*-dev" ]
            "":
                packageScript: |
                    autotoolsPackageTgt

                    # make sure that prefixed versions are available on native build
                    if [[ ${AUTOCONF_HOST:-$AUTOCONF_BUILD} = ${AUTOCONF_TARGET:-${AUTOCONF_HOST:-$AUTOCONF_BUILD}} ]]
                    then
                        pushd ./${BINUTILS_PREFIX:-/usr}/bin
                        for i in *; do
                            ln -s "$i" "${AUTOCONF_HOST:-$AUTOCONF_BUILD}-$i"
                        done
                        popd
                    fi

                provideDeps: [ "*-tgt" ]
                provideTools:
                    binutils: usr/bin

    libiberty:
        depends:
            - devel::binutils-dev
        buildScript: |
            autotoolsBuild $1/libiberty \
                --enable-install-libiberty
            if [[ -e install/usr/lib64 ]]; then
                mkdir -p install/usr/lib
                mv install/usr/lib64/* install/usr/lib
            fi
        multiPackage:
            dev:
                packageScript: autotoolsPackageDev
                provideDeps: [ "*-dev" ]
            tgt:
                packageScript: autotoolsPackageTgt
                provideDeps: [ "*-tgt" ]
