inherit: [make, patch, strip]

depends:
    # This version of glibc apparently creates an endless loop with GNU make
    # 4.4. See https://sourceware.org/pipermail/libc-help/2023-September/006486.html
    # for one of the bug reports. Because we want to have this old glibc
    # version, downgrading make seems to be the only viable option.
    - name: devel::compat::make
      use: [tools]

    - kernel::linux-libc-headers
    -
        name: devel::compat::gcc-cross-bare
        use: [tools]

# Make 4.3 only supports pipes.
jobServer: "pipe"

metaEnvironment:
    PKG_LICENSE: "GPL-2.0-or-later AND LGPL-2.1-or-later"
    PKG_VERSION: "2.31"

checkoutSCM:
    scm: url
    url: ${GNU_MIRROR}/glibc/glibc-${PKG_VERSION}.tar.xz
    digestSHA256: "9246fe44f68feeec8c666bb87973d590ce0137cca145df014c72ec95be9ffd17"
    stripComponents: 1

checkoutDeterministic: True
checkoutScript: |
    patchApplySeries $<@glibc/*.diff@>

buildVars: [AUTOCONF_TARGET]
buildTools: [host-toolchain, target-toolchain, bison]
buildToolsWeak: [python3, m4]
buildScript: |
    EXTRA=
    [ -e $1/usr/include/selinux/selinux.h ] || EXTRA+=" --without-selinux"

    mkdir -p build install
    pushd build
    if [[ $1/configure -nt .configure.stamp ]] ; then
        $1/configure \
            --prefix=/usr                    \
            --host=${AUTOCONF_TARGET}        \
            --build=$($1/scripts/config.guess) \
            --enable-kernel=5.4           \
            --with-headers=$2/usr/include \
            --enable-obsolete-rpc \
            --libdir=/usr/lib \
            $EXTRA
        touch .configure.stamp
    fi

    makeParallel rootsbindir=/usr/sbin slibdir=/usr/lib
    make install rootsbindir=/usr/sbin slibdir=/usr/lib DESTDIR=${PWD}/../install
    popd
    cp -a $2/usr/include install/usr/

packageScript: |
    cp -a $1/install/* .
    stripAll .
