inherit: [make, strip]

metaEnvironment:
    PKG_VERSION: "r-2025-W50"
    PKG_LICENSE: "MIT AND GPL-3.0-only with GCC-exception-3.1 AND GPL-3.0-or-later AND GPL-2.0-only"

checkoutSCM:
    - scm: url
      dir: .
      url: $GITHUB_MIRROR/L4Re/mk/archive/refs/tags/${PKG_VERSION}.tar.gz
      digestSHA1: 63828669ccdbe441c567965894938237c64ebb20
      stripComponents: 1
    - scm: url
      dir: pkg/l4re-core
      url: $GITHUB_MIRROR/L4Re/l4re-core/archive/refs/tags/${PKG_VERSION}.tar.gz
      digestSHA1: 05265684049f9ba9c62a0d4a1fe06ff79494a8d5
      stripComponents: 1

buildTools: [host-toolchain, target-toolchain, flex, bison]
buildToolsWeak: [m4, perl]
buildVars: [ARCH, CROSS_COMPILE]
buildScript: |
    case $ARCH in
        arm64)
            DEFCONFIG=config.arm64-virt-v8a
            ;;
        x86_64)
            DEFCONFIG=config.amd64
            ;;
        *)
            echo "Unsupported: $ARCH" >&2
            exit 1
    esac

    if [[ ! -e build/.bob-init-done ]] ; then
        cp "$1/mk/defconfig/$DEFCONFIG" defconfig
        echo "CONFIG_COMPILER_RT_USE_TOOLCHAIN_LIBGCC=n" >> defconfig
        echo "CONFIG_BID_STRIP_BINARIES=n" >> defconfig
        rm -rf build
        makeParallel -C "$1" B="$PWD/build" DEFCONFIG="$PWD/defconfig"
        makeParallel -C build olddefconfig
        touch build/.bob-init-done
    fi

    cd build
    makeParallel sysroot

packageScript: |
    cp -a $1/build/sysroot/* .
    stripAll .
