inherit: [make, strip, "basement::update-config", install, patch]

metaEnvironment:
    PKG_VERSION: "5.40.2"

privateEnvironment:
    APPLY_UPDATE_CONFIG: "no"
    PERL_CROSS_VERSION: "1.6.2"
    PERL_ARCH: "$(if-then-else,$(eq,${ARCH},arm64),aarch64-linux,${ARCH}-linux)"

checkoutSCM:
    -
        scm: url
        url: "http://www.cpan.org/src/5.0/perl-${PKG_VERSION}.tar.xz"
        digestSHA256: "0551c717458e703ef7972307ab19385edfa231198d88998df74e12226abf563b"
        dir: perl
        stripComponents: 1
    -
        scm: url
        url: "https://github.com/arsv/perl-cross/raw/releases/perl-cross-${PERL_CROSS_VERSION}.tar.gz"
        digestSHA256: "131f7496152ee32067dbac2bc9b44b2f582fc778140e545701b3b2faee782f1d"
        extract: False
        dir: perl-cross
        fileName: perl-cross.tar.gz

checkoutDeterministic: True
checkoutScript: |
    if [ ! -e perl/cnf ]; then
      tar --strip-components=1 -C perl -xf perl-cross/perl-cross.tar.gz
    fi
    pushd perl
    patchApplySeries -p1 $<@perl/*.patch@>
    popd
    updateConfigAllRecursive

buildTools: [host-toolchain, target-toolchain]
buildVars: [AUTOCONF_HOST, CROSS_COMPILE, TOOLCHAIN_SYSROOT,
            CPPFLAGS, CFLAGS, LDFLAGS]
buildScript: |
    mkdir -p build install
    cd build

    SYSROOT=$(${CROSS_COMPILE:-}gcc --print-sysroot)

    # perl-cross needs a relative path :(
    $(realpath --relative-to=. $1)/perl/configure \
        ${AUTOCONF_HOST:+--target=${AUTOCONF_HOST}} \
        ${CROSS_COMPILE:+--target-tools-prefix=${CROSS_COMPILE}} \
        --prefix=/usr \
        ${SYSROOT:+--sysroot=${SYSROOT}} \
        -Dld="${CROSS_COMPILE:-}gcc" \
        -Dccflags="$CFLAGS" \
        -Dldflags="$LDFLAGS -lm" \
        -Dmydomain="" \
        -Dmyhostname="bob" \
        -Dmyuname="Buildroot 1.2.3" \
        -Dosname=linux \
        -Dosvers=4.1.0 \
        -Dperladmin=root \
        -Duserelocatableinc \

    makeParallel all
    make DESTDIR=$PWD/../install install.perl

packageVars: [PKG_VERSION, PERL_ARCH]

multiPackage:
    dev:
        packageScript: |
            cp -a $1/install/* .

            # remove absolute sysroot argument from Config_heavy.pl.
            # This would be used to compile perl modules.
            find usr/lib/perl5/${PKG_VERSION} -name Config_heavy.pl \
                -exec sed -i 's/--sysroot=[^\ ]* //g' {} \;

            # create config_heavy-target symlink used for cross compilation.
            # see perl-configpm-switch.patch
            pushd usr/lib/perl5/${PKG_VERSION}/${PERL_ARCH}
            ln -s Config_heavy.pl Config_heavy-target.pl
            popd

            installFixShebang

        provideVars:
            PERL_VERSION: "${PKG_VERSION}"
            PERL_ARCH: "${PERL_ARCH}"

    "":
        packageScript: |
            cp -a $1/install/* .

            rm -rf usr/lib/perl5/${PKG_VERSION}/pod
            rm -rf usr/lib/perl5/${PKG_VERSION}/${PERL_ARCH}/CORE

            find usr/lib/perl5/ -name 'extralibs.ld' -print0 | xargs -0 rm -f
            find usr/lib/perl5/ -name '*.bs' -print0 | xargs -0 rm -f
            find usr/lib/perl5/ -name '.packlist' -print0 | xargs -0 rm -f

            # remove absolute sysroot argument from Config_heavy.pl.
            # This would be used to compile perl modules.
            find usr/lib/perl5/${PKG_VERSION} -name Config_heavy.pl \
                -exec sed -i 's/--sysroot=[^\ ]* //g' {} \;

            stripAll .
            installFixShebang

provideTools:
    perl:
        path: "usr/bin"
